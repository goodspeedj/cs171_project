<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link type="text/css" rel="stylesheet" href="css/style.css"/>
    <title>CS171 Project II: Jim Goodspeed &amp; Devin Shackle</title>

    <!-- D3 Libraries -->
    <script type="text/javascript" src="js/d3.v3.min.js"></script>
    <script type="text/javascript" src="js/d3.csv.js"></script>

    <!-- Library to render table -->
    <script type="text/javascript" src="js/divgrid.js"></script>

  </head>
  <body>
    <header>
      <div id="header">
        <p class="title">The Economics of War</p>
        CS 171/CSCI E-64: Visualization<br />
        Project II
      </div>
      <div id="name">
        James Goodspeed - jgoodsp@fas.harvard.edu<br />
        Devin Shackle - devinshackle@gmail.com
      </div>
    </header>

    <div id="dropdown">
      <form>
        <select id="list" onchange="selectConflict()">

          <option>Please choose a conflict to examine</option>
          <option>Persian Gulf War</option>
          <option>Falklands War</option>  
          <option>US Invasion of Panama</option>
          <option>Kosovo War</option>
          <option>Iraq War</option>
          <option>Fake War</option>
        </select>
        <p id="description"></p>
      </form>
    </div>

    <!-- Place holder for the parallel coordinates graph -->
    <div id="vis"></div>

    <!-- Place holder for detail table -->
    <div id="grid">
      <table>
        <thead>
          <tr>
            <th class="col-0">Country</th>
            <th class="col-1">Year</th>
            <th class="col-2">GDP (Billions)</th>
            <th class="col-3">GNI (Billions)</th>
            <th class="col-4">Military Spending (Billions)</th>
            <th class="col-5">Inflation</th>
            <th class="col-6">Revenue</th>
            <th class="col-7">Cash Surplus</th>
            <th class="col-8">Unemployment Rate</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
    
    <script type="text/javascript">

      /*
        The code below for the parallel coordinates graph is based on the code for the Edgar Anderson's Iris
        visualization found here: http://mbostock.github.com/d3/talk/20111116/iris-parallel.html
       */

      var data = "data/conflict.csv";

      //var countries = ["USA", "GBR","PAK","AFG","CAN","AUS","IRQ","POL","KOR","UKR","ITA","GEO","ESP","DNK","NLD"];
      var countries = ["USA","CAN", "GBR"];
      var indicators = ["GDP (Billions)","GNI (Billions)","Military Spending (Billions)","Inflation","Revenue","Cash Surplus","Unemployment Rate"];

      //var margin = [190, 170, 50, 260];
      var margin = [60, 120, 60, 120];
      var width  = 1024 - margin[1] - margin[3];
      var height = 500 - margin[0] - margin[2];

      var x = d3.scale.ordinal().domain(indicators).rangePoints([0, width]);
      var y = {};

      var line = d3.svg.line();
      var axis = d3.svg.axis().orient("left");
      var foreground;
      var filterData = new Array();

      var svg = d3.select("#vis").append("svg:svg")
          .attr("width", width + margin[1] + margin[3])
          .attr("height", height + margin[0] + margin[2])
        .append("svg:g")
          .attr("transform", "translate(" + margin[0] + "," + margin[0] + ")");


      // Gets the selected item from the pull down
      function getSelected() {
          var list = document.getElementById("list");
          var item = list.options[list.selectedIndex].value;
          console.log(item);

          return item;
      }


      function highlight(d) {
          alert(d);
      }




      // Displays the detail table
      function detailTable(data) {

        var columns = ["Country","Year","GDP (Billions)", "GNI (Billions)", "Military Spending (Billions)","Inflation","Revenue","Cash Surplus","Unemployment Rate"];

        var rows = d3.select("tbody")
            .selectAll("tr")
            .data(data);

        rows.enter()
            .append("tr")
            //.attr("onclick", "highlight(data)");
            .attr("onclick", "alert(columns)");

        // create a cell in each row for each column
        var cells = rows.selectAll("td")
            .data(function(row) {
              return columns.map(function(column) {
                return {column: column, value: row[column]};
              });
            })
          .enter()
            .append("td")
              .text(function(d) { return d.value; });

        rows.exit().remove();

      }




      function selectConflict() {


      d3.csv(data, function(fullData) {

        var conflicts = fullData.filter(function(row) {
          return row["Conflict"] == getSelected();
        });

        
        


        // display all data
        detailTable(conflicts);

        // Create a scale and brush for each economic indicator
        indicators.forEach(function(d) {

          redrawAxis();

          // scale
          y[d] = d3.scale.linear()
              .domain(d3.extent(conflicts, function(p) { return +p[d]; }))
              .range([height, 0]);

          // brush
          y[d].brush = d3.svg.brush(conflicts)
              .y(y[d])
              .on("brush", brush);

        });

        redrawPath(conflicts);


        // Add a legend for the countries being displayed
        var legend = svg.selectAll("g.legend")
            .data(countries)
          .enter().append("svg:g")
            .attr("class", "legend")
            .attr("transform", function(d, i) { return "translate(850," + (i * 20 + 50) + ")"; });


        // color lines in legend for each country
        legend.append("svg:line")
            .attr("class", String)
            .attr("x2", 8);


        // country names in the legend
        legend.append("svg:text")
            .attr("x", 12)
            .attr("dy", ".31em")
            .text(function(d) { return "Country: " + d; })
            .on("click", detailTableFromLegend);


        // Add foreground lines (the main lines in the visualization)
        foreground = svg.append("svg:g")
            .attr("class", "foreground")
          .selectAll("path")
            .data(conflicts)
          .enter().append("svg:path")
            .attr("d", path)
            .attr("d", path)
            .attr("class", function(d) { return d.Country_Code; });



        // Add a group element for each economic indicator
        var g = svg.selectAll(".indicator")
            .data(indicators)
          .enter().append("svg:g")
            .attr("class", "indicator")
            .attr("transform", function(d) { return "translate(" + x(d) + ")"; })
            .call(d3.behavior.drag()
            .origin(function(d) { return {x: x(d)}; })
            .on("dragstart", dragstart)
            .on("drag", drag)
            .on("dragend", dragend)
            );


        // Add an axis and title
        g.append("svg:g")
            .attr("class", "axis")
            .each(function(d) { d3.select(this).call(axis.scale(y[d])); })
          .append("svg:text")
            .attr("text-anchor", "middle")
            .attr("y", -9)
            .text(String);


        // Add a brush for each axis
        g.append("svg:g")
            .attr("class", "brush")
            .each(function(d) { d3.select(this).call(y[d].brush); })
          .selectAll("rect")
            .attr("x", -8)
            .attr("width", 20);


        // used for dragging y axis
        function dragstart(d) {
          i = indicators.indexOf(d);
        }


        // used for dragging y axis
        function drag(d) {
          x.range()[i] = d3.event.x;
          indicators.sort(function(a, b) { return x(a) - x(b); });
          g.attr("transform", function(d) { return "translate(" + x(d) + ")"; });
          foreground.attr("d", path);
        }


        // used for dragging y axis
        function dragend(d) {
          x.domain(indicators).rangePoints([0, width]);
          var t = d3.transition().duration(500);
          t.selectAll(".indicator").attr("transform", function(d) { return "translate(" + x(d) + ")"; });
          t.selectAll(".foreground path").attr("d", path);
        }
      });

      }


      function redrawPath(data) {
        svg.selectAll("path")
            .data(data)
            .transition()
              .delay(1000)
              .duration(5000)
            .attr("d", path)
            .attr("class", function(d) { return d.Country_Code; });
      }

      function redrawAxis() {
        
        svg.selectAll(".axis")
          .attr("class", "axis")
            .each(function(d) { d3.select(this).call(axis.scale(y[d])); }) 
          .append("svg:text")
            .attr("text-anchor", "middle")
            .attr("y", -9)
            .text(String);

          
      }


      // Returns the path for a given data point
      function path(d) {
        return line(indicators.map(function(p) { return [x(p), y[p](d[p])]; }));
      }


      function fromTablePath(d) {
          //console.log(d);
          return line(indicators.map(function(p) { return [x(p), y[p](d[p])]; }));
      }


      // Handles a brush event, toggling the display of foreground lines
      function brush() {

        var actives = indicators.filter(function(p) { return !y[p].brush.empty(); });
        var extents = actives.map(function(p) { return y[p].brush.extent(); });
        var filterData = [];

        foreground.classed("fade", function(d, index) {

          return !actives.every(function(p, i) {

            // For records (lines) that are in the brush add to the filterData array
            if (extents[i][0] <= d[p] && d[p] <= extents[i][1]) {
                filterData.push(d);  
            }

            // Create the detail table based on the contents of the filterData array
            detailTable(filterData);

            return extents[i][0] <= d[p] && d[p] <= extents[i][1];
            
          });
        });
      }


      // Displays the detail table
      function detailTableFromLegend(d) {

        //console.log(d);
        var grid = d3.divgrid();
        var cols = grid.columns(["Country","Year","GDP (Billions)", "GNI (Billions)", "Military Spending (Billions)","Inflation","Revenue","Cash Surplus","Unemployment Rate"]);
        var filterDat = [{}];

        d3.csv(data, function(dat) {
          var index = 0;

          // extract out the records we want and put in new array
          for (var i = 0; i < dat.length; i++) {
              if (dat[i].Country_Code == d) {
                  filterDat[index] = dat[i];
                  index++;
              }
          }
          
          // display the records from the new array
          d3.select('#grid')
            .datum(filterDat)
            .call(grid)

        });
      }


            


    </script>
  </body>
</html>
